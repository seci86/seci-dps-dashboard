<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SECI Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        font-size: 22px;
      }
      .tab-sidebar {
        min-width: 220px;
        border-right: 1px solid #ddd;
        height: 100dvh;
        position: sticky;
        top: 0;
      }
      .tab-content-area {
        flex-grow: 1;
      }
      .top-bar {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
        font-weight: 500;
        font-size: 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }
      .tab-button {
        text-align: left;
        width: 100%;
      }
      .tab-button.active {
        background-color: #e9ecef;
        font-weight: bold;
      }
      .dashboard-area,
      .department-area {
        padding: 20px;
      }
      .chart-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .chart-title {
        font-size: 1rem;
        margin-top: 10px;
      }
      .chart-center-label {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        font-weight: bold;
      }
      .target-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
      }
      .overdue {
        color: red;
        font-weight: bold;
      }
      .upcoming {
        color: green;
        font-weight: bold;
      }
      .tab-sidebar.collapsed {
        min-width: 70px;
        max-width: 70px;
      }
      .tab-sidebar.collapsed .tab-text {
        display: none;
      }
      .collapse-btn {
        margin: 10px 0;
      }
      /* .selected-stat {
        border: 2px solid #0d6efd;
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.5);
      } */
      .target-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .target-table th,
      .target-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      .target-table th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <div class="d-flex">
      <div class="tab-sidebar d-flex flex-column p-2 bg-light" id="sidebar">
        <button class="btn btn-secondary btn-sm collapse-btn" id="collapseBtn">
          <i class="bi bi-list"></i>
        </button>
        <div id="sidebarButtons" class="d-flex flex-column mt-2"></div>
      </div>
      <div class="tab-content-area d-flex flex-column w-100">
        <div class="top-bar">
          <span id="topBarTitle">SECI Dashboard > Home</span>
          <div class="d-flex gap-2 mt-2 mt-md-0">
            <button
              class="btn btn-success btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#statModal"
            >
              <i class="bi bi-plus-circle me-1"></i> Add Statistic
            </button>
            <!-- <button
              class="btn btn-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#targetModal"
            >
              <i class="bi bi-flag me-1"></i> Add Targets
            </button> -->
          </div>
        </div>
        <div class="dashboard-area" id="homeArea">
          <div class="row g-3" id="chartGrid"></div>
        </div>
        <div class="department-area d-none" id="departmentArea">
          <div class="d-flex flex-wrap gap-3">
            <!-- Left side: Stats, Charts, Targets -->
            <div class="flex-grow-1" style="min-width: 300px">
              <div class="row g-3" id="departmentStats"></div>
              <div class="mt-3" id="chartDetailsSection"></div>
              <div class="mt-4" id="targetSection"></div>
            </div>

            <!-- Right side: Editable Table -->
            <!-- Right side: Editable Table -->
            <!-- <div id="taskTableArea" style="min-width: 300px; max-width: 400px">
              <h4 class="mb-2">Department Task Table</h4>
              <div id="tableContainer"></div>
              <button
                class="btn btn-sm btn-outline-primary mt-2"
                id="editTableBtn"
              >
                <i class="bi bi-pencil"></i> Edit Table
              </button>
            </div> -->
          </div>
        </div>
      </div>
    </div>

    <!-- Statistic Modal -->
    <div class="modal fade" id="statModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <form id="statForm">
            <div class="modal-header">
              <h5 class="modal-title">Add Statistic</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="departmentSelect" required>
                  <option disabled selected>Select Department</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Statistic Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="statName"
                  maxlength="100"
                  required
                />
              </div>
              <div id="fieldsContainer" class="mb-3">
                <label class="form-label">Optional Labeled Fields</label>
                <div id="fieldsList"></div>
                <button
                  type="button"
                  class="btn btn-sm btn-secondary mt-2"
                  onclick="addField()"
                >
                  Add Field
                </button>
                <small class="text-muted d-block mt-1"
                  >If added, pie chart will show labeled fields instead of
                  Current/Remaining.</small
                >
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary" id="statSubmitBtn">
                Add
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Target Modal -->
    <div class="modal fade" id="targetModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="targetForm">
            <div class="modal-header">
              <h5 class="modal-title">Add Target</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="targetDepartment" required>
                  <option disabled selected>Select Department</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Target Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="targetTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Target Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="targetDate"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Add Target</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const departments = [
        "Home",
        "Business Development",
        "Contracts & Procurement",
        "Energy Mangement",
        "Projects",
        "RESCO",
        "Engineering",
        "QA",
        "O&M",
      ];
      const icons = [
        "bi-house-door",
        "bi-briefcase",
        "bi-currency-rupee",
        "bi-lightning-charge",
        "bi-diagram-3",
        "bi-building",
        "bi-tools",
        "bi-shield-check",
        "bi-gear",
      ];
      const vibrantColors = [
        "#ff4d4d",
        "#4d79ff",
        "#28a745",
        "#ffc107",
        "#ff66cc",
        "#00cccc",
        "#ff9933",
        "#9966ff",
        "#00b894",
      ];

      const chartGrid = document.getElementById("chartGrid");
      const sidebar = document.getElementById("sidebarButtons");
      const departmentSelect = document.getElementById("departmentSelect");
      const targetDepartment = document.getElementById("targetDepartment");
      const departmentStats = document.getElementById("departmentStats");
      const homeArea = document.getElementById("homeArea");
      const deptArea = document.getElementById("departmentArea");
      const topBarTitle = document.getElementById("topBarTitle");
      const targetSection = document.getElementById("targetSection");

      const charts = {};
      const departmentData = {};
      const homeSelectedStats = {};
      const targets = {};
      const departmentTables = {};

      departments.forEach((dept, i) => {
        sidebarButtons.innerHTML += `<button class="btn tab-button ${
          dept === "Home" ? "active" : ""
        } mb-2" data-tab="${dept}"><i class="bi ${
          icons[i]
        } me-2"></i> <span class="tab-text">${dept}</span></button>`;
        if (dept !== "Home") {
          departmentSelect.innerHTML += `<option>${dept}</option>`;
          targetDepartment.innerHTML += `<option>${dept}</option>`;
          const col = document.createElement("div");
          col.className = "col-6 col-md-3 position-relative";
          col.innerHTML = `
                            <div class="chart-card">
                              <div class="fw-bold mb-1">${dept}</div>
                              <canvas id="chart-${dept}" width="150" height="150"></canvas>
                              <div class="chart-center-label" id="label-${dept}"></div>
                              <div class="chart-title" id="title-${dept}">Capex Projects</div>
                            </div>`;
          chartGrid.appendChild(col);

          charts[dept] = new Chart(
            document.getElementById(`chart-${dept}`).getContext("2d"),
            {
              type: "doughnut",
              data: {
                labels: [],
                datasets: [
                  {
                    data: [0, 1],
                    backgroundColor: [vibrantColors[i], "#dee2e6"],
                  },
                ],
              },
              options: {
                cutout: "70%",
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const index = context.dataIndex;
                        const label = context.chart.data.labels[index];
                        const value =
                          context.chart.data.datasets[0].data[index];
                        const tooltipData =
                          context.chart.data.datasets[0].tooltipData[index] ||
                          [];

                        const lines = [`${label}: ${value}`];
                        tooltipData.forEach((item) => {
                          lines.push(`${item.key}: ${item.value}`);
                        });
                        return lines;
                      },
                    },
                  },
                },
              },
            }
          );

          departmentData[dept] = [];
          targets[dept] = [];
          targets[dept].push({
            title: "Meeting with Power Developer",
            date: "2025-03-15",
          });

          const headcountTotal = getRandomInt(50, 500);
          const headcountCurrent = getRandomInt(0, headcountTotal);
          const milestonesTotal = getRandomInt(5, 20);
          const milestonesCurrent = getRandomInt(0, milestonesTotal);

          departmentData[dept].push({
            name: "Capex Projects",
            fields: [
              {
                label: "Leh",
                value: 25,
                tooltipData: [
                  { key: "Capacity", value: "25MW + 50MWh" },
                  { key: "LOA Date", value: "20-11-2024" },
                  { key: "SCOD/Duration", value: "36 months" },
                  { key: "Extended COD", value: "-" },
                  { key: "Land", value: "-" },
                  { key: "% Physical Progress", value: "-" },
                  { key: "% Financial Progress", value: "-" },
                ],
                tableData: [
                  {
                    issues:
                      " Issue of civil drawings for MCR and MMS foundations",
                    status: "Pending",
                    dept: "Civil Engineering",
                    date: "2025-07-20",
                  },
                ],
              },
              {
                label: "Getalsud",
                value: 100,
                tooltipData: [
                  { key: "Capacity", value: "100MW" },
                  { key: "LOA Date", value: "07-05-2024" },
                  { key: "SCOD/Duration", value: "07/12/2025, 18 months" },
                  { key: "Extended COD", value: "28/02/2026" },
                  { key: "Land", value: "Reservoir" },
                  { key: "% Physical Progress", value: "-" },
                  { key: "% Financial Progress", value: "-" },
                ],
                tableData: [
                  {
                    issues: "Transmission line approval",
                    status: "Pending",
                    dept: "Civil Engineering",
                    date: "2025-07-20",
                  },
                ],
              },
              {
                label: "Ramagiri",
                value: 300,
                tooltipData: [
                  { key: "Capacity", value: "300MW" },
                  { key: "LOA Date", value: "06-02-2024" },
                  { key: "SCOD/Duration", value: "12 months" },
                  { key: "Extended COD", value: "-" },
                  { key: "Land", value: "1033 Acre" },
                  { key: "% Physical Progress", value: "-" },
                  { key: "% Financial Progress", value: "-" },
                ],
                tableData: [
                  {
                    issues: "Pile marking coordinate drawing is required",
                    status: "Pending",
                    dept: "Civil Engineering",
                    date: "2025-07-20",
                  },
                  {
                    issues: "ICR foundation drawings required",
                    status: "In Progress",
                    dept: "Design Team",
                    date: "2025-07-25",
                  },
                  {
                    issues: "Inverter transformer drawings",
                    status: "Completed",
                    dept: "Electrical Engineering",
                    date: "2025-07-18",
                  },
                  {
                    issues: "33kV switch gear foundation",
                    status: "Pending",
                    dept: "Electrical Engineering",
                    date: "2025-07-28",
                  },
                  {
                    issues:
                      "String combiner box foundation and coordinates drawing required",
                    status: "In Progress",
                    dept: "Civil Engineering",
                    date: "2025-07-22",
                  },
                  {
                    issues:
                      "Cable trench layout & Overhead transmission line layout",
                    status: "Pending",
                    dept: "Transmission",
                    date: "2025-07-30",
                  },
                ],
              },
              {
                label: "Dhar",
                value: 100,
                tooltipData: [
                  { key: "Capacity", value: "100MW" },
                  { key: "LOA Target", value: "-" },
                ],
                tableData: [
                  {
                    issues: "Bid Opening for Module",
                    status: "Pending",
                    dept: "Environment",
                    date: "2025-07-10",
                  },
                ],
              },
              {
                label: "Radhanesda",
                value: 700,
                tooltipData: [
                  { key: "Capacity", value: "700MW" },
                  { key: "LOA Target", value: "-" },
                ],
                tableData: [
                  {
                    issues: "Bid Opening for Module",
                    status: "Pending",
                    dept: "Environment",
                    date: "2025-07-04",
                  },
                ],
              },
              {
                label: "NDMC",
                value: 300,
                tooltipData: [
                  { key: "Capacity", value: "300MW" },
                  { key: "LOA Target", value: "2022" },
                ],
                tableData: [
                  {
                    issues: "Project registration completion",
                    status: "Pending",
                    dept: "Environment",
                    date: "2025-07-10",
                  },
                ],
              },
            ],
          });
          departmentTables[dept] = {
            columns: ["Task", "Status"],
            rows: [
              ["Complete Site Survey", "Done"],
              ["Finalize Contract", "Pending"],
            ],
          };
          homeSelectedStats[dept] = 1;
          updateHomeChart(dept);
        }
      });

      document.querySelectorAll(".tab-button").forEach((btn) =>
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tab-button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tab;
          topBarTitle.textContent = `SECI Dashboard > ${tab}`;
          if (tab === "Home") {
            homeArea.classList.remove("d-none");
            deptArea.classList.add("d-none");
            // document.getElementById("taskTableArea").style.display = "none";
          } else {
            homeArea.classList.add("d-none");
            deptArea.classList.remove("d-none");
            // document.getElementById("taskTableArea").style.display = "block";
            renderDepartmentStats(tab);
          }
        })
      );

      // Helper for managing fields in modal
      let editingStat = null; // { dept, index }
      function clearFieldsList() {
        document.getElementById("fieldsList").innerHTML = "";
      }
      function addField(
        label = "",
        value = "",
        tooltipData = [],
        tableData = []
      ) {
        const fieldsList = document.getElementById("fieldsList");
        const div = document.createElement("div");
        div.className = "card mb-3 p-3";
        div.innerHTML = `
        <div class="mb-2">
          <label>Label:</label>
          <input type="text" class="form-control field-label" placeholder="Label" value="${label.replace(
            /"/g,
            "&quot;"
          )}">
        </div>
        <div class="mb-2">
          <label>Value:</label>
          <input type="number" min="0" class="form-control field-value" placeholder="Value" value="${value}">
        </div>

        <div class="mb-2">
          <label>Tooltip Data:</label>
          <div class="tooltip-list mb-2"></div>
          <button type="button" class="btn btn-sm btn-outline-primary add-tooltip-btn mb-2">Add Tooltip Item</button>
        </div>

        <div class="mb-2">
          <label>Table Data:</label>
          <div class="tabledata-list mb-2"></div>
          <button type="button" class="btn btn-sm btn-outline-primary add-tabledata-btn mb-2">Add Table Row</button>
        </div>

        <button type="button" class="btn btn-outline-danger" onclick="this.parentNode.remove()">Remove Label</button>
      `;
        fieldsList.appendChild(div);

        // Pre-fill Tooltip Data
        const tooltipList = div.querySelector(".tooltip-list");
        tooltipData.forEach((td) =>
          addTooltipItem(tooltipList, td.key, td.value)
        );

        div.querySelector(".add-tooltip-btn").onclick = () =>
          addTooltipItem(tooltipList);

        // Pre-fill Table Data
        const tableDataList = div.querySelector(".tabledata-list");
        tableData.forEach((td) =>
          addTableDataRow(tableDataList, td.issues, td.status, td.dept, td.date)
        );

        div.querySelector(".add-tabledata-btn").onclick = () =>
          addTableDataRow(tableDataList);
      }
      function addTooltipItem(container, key = "", value = "") {
        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
        <input type="text" class="form-control tooltip-key" placeholder="Key" value="${key.replace(
          /"/g,
          "&quot;"
        )}">
        <input type="text" class="form-control tooltip-value" placeholder="Value" value="${value.replace(
          /"/g,
          "&quot;"
        )}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentNode.remove()">&#10006;</button>
      `;
        container.appendChild(div);
      }

      function addTableDataRow(
        container,
        issues = "",
        status = "",
        dept = "",
        date = ""
      ) {
        const div = document.createElement("div");
        div.className = "input-group mb-2";
        div.innerHTML = `
        <input type="text" class="form-control td-issues" placeholder="Issues" value="${issues.replace(
          /"/g,
          "&quot;"
        )}">
        <input type="text" class="form-control td-status" placeholder="Status" value="${status.replace(
          /"/g,
          "&quot;"
        )}">
        <input type="text" class="form-control td-dept" placeholder="Department" value="${dept.replace(
          /"/g,
          "&quot;"
        )}">
        <input type="text" class="form-control td-date" placeholder="Date" value="${date.replace(
          /"/g,
          "&quot;"
        )}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentNode.remove()">&#10006;</button>
      `;
        container.appendChild(div);
      }
      function getFieldsFromModal() {
        const fields = [];
        document.querySelectorAll("#fieldsList .card").forEach((div) => {
          const label = div.querySelector(".field-label").value.trim();
          const value = parseInt(div.querySelector(".field-value").value);

          const tooltipData = [];
          div.querySelectorAll(".tooltip-list .input-group").forEach((tdiv) => {
            const key = tdiv.querySelector(".tooltip-key").value.trim();
            const val = tdiv.querySelector(".tooltip-value").value.trim();
            if (key) tooltipData.push({ key, value: val });
          });

          const tableData = [];
          div
            .querySelectorAll(".tabledata-list .input-group")
            .forEach((tdiv) => {
              const issues = tdiv.querySelector(".td-issues").value.trim();
              const status = tdiv.querySelector(".td-status").value.trim();
              const dept = tdiv.querySelector(".td-dept").value.trim();
              const date = tdiv.querySelector(".td-date").value.trim();
              if (issues) tableData.push({ issues, status, dept, date });
            });

          if (label && !isNaN(value)) {
            fields.push({ label, value, tooltipData, tableData });
          }
        });
        return fields.length > 0 ? fields : null;
      }
      function setFieldsInModal(fields) {
        clearFieldsList();
        if (fields && Array.isArray(fields)) {
          fields.forEach((f) =>
            addField(
              f.label,
              f.value,
              JSON.stringify(f.tooltipData || [], null, 2),
              JSON.stringify(f.tableData || [], null, 2)
            )
          );
        }
      }
      function setFieldsInModal(fields) {
        clearFieldsList();
        if (fields && Array.isArray(fields)) {
          fields.forEach((f) =>
            addField(f.label, f.value, f.tooltipData || [], f.tableData || [])
          );
        }
      }
      document
        .getElementById("statModal")
        .addEventListener("hidden.bs.modal", resetStatModal);

      document.getElementById("statForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const dept = departmentSelect.value;
        const name = document.getElementById("statName").value;
        const fields = getFieldsFromModal();
        if (!fields || fields.length < 1)
          return alert("Please add at least one labeled statistic.");
        const total = fields.reduce((sum, f) => sum + f.value, 0);
        // const fields = getFieldsFromModal();
        // if (fields) {
        //   // sum of field values should not exceed total
        //   const sum = fields.reduce((a, b) => a + b.value, 0);
        //   if (sum > total)
        //     return alert("Sum of field values cannot exceed Total.");
        // }
        if (editingStat) {
          // Edit existing
          const { dept: editDept, index } = editingStat;
          departmentData[editDept][index] = {
            name,
            total,
            current,
            ...(fields ? { fields } : {}),
          };
          updateHomeChart(editDept);
          if (topBarTitle.textContent.endsWith(editDept))
            renderDepartmentStats(editDept);
        } else {
          // Add new
          departmentData[dept].push({
            name,
            total,
            current,
            ...(fields ? { fields } : {}),
          });
          if (
            homeSelectedStats[dept] === null ||
            typeof homeSelectedStats[dept] === "undefined"
          )
            homeSelectedStats[dept] = departmentData[dept].length - 1;
          updateHomeChart(dept);
        }
        bootstrap.Modal.getInstance(
          document.getElementById("statModal")
        ).hide();
        e.target.reset();
      });

      document.getElementById("targetForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const dept = targetDepartment.value;
        const title = document.getElementById("targetTitle").value;
        const date = document.getElementById("targetDate").value;
        targets[dept].push({ title, date });
        bootstrap.Modal.getInstance(
          document.getElementById("targetModal")
        ).hide();
        e.target.reset();
        if (topBarTitle.textContent.endsWith(dept)) renderDepartmentStats(dept);
      });

      function renderDepartmentStats(dept) {
        document.getElementById("chartDetailsSection").innerHTML = "";
        departmentStats.innerHTML = "";
        departmentStats.innerHTML =
          "<h4 class='mb-3'>Department Headcount</h4>";
        departmentStats.innerHTML +=
          '<div class="d-flex align-items-center"><div class="d-flex align-items-center me-4"><span class="mx-2">Total headcount:</span><span>36</span></div><div class="d-flex align-items-center me-4"><i class="bi bi-person-fill fs-4"></i><span class="mx-2">Regular:</span><span>30</span></div><div class="d-flex align-items-center me-4"><i class="bi bi-person-fill fs-4"></i><span class="mx-2">Contractual:</span><span>5</span></div><div class="d-flex align-items-center"><i class="bi bi-person-fill fs-4"></i><span class="mx-2">YP:</span><span>1</span></div></div>';
        departmentStats.innerHTML +=
          "<h4 class='mb-3'>Key Issues / Targets</h4><p><i>Click on the label to view issues</i></p>";
        departmentData[dept].forEach((stat, index) => {
          const colorIndex = departments.indexOf(dept);
          const col = document.createElement("div");
          col.className = "col-12 col-md-4 mx-auto mb-3";
          // Compose chart data
          let chartLabels, chartData, chartColors;
          if (
            stat.fields &&
            Array.isArray(stat.fields) &&
            stat.fields.length > 0
          ) {
            chartLabels = stat.fields.map((f) => f.label);
            chartData = stat.fields.map((f) => f.value);
            chartColors = chartLabels.map(
              (_, i) => vibrantColors[(colorIndex + i) % vibrantColors.length]
            );
            // chartExtras = stat.fields.map((f) => f.extra || "");
            chartColors = chartLabels.map(
              (_, i) => vibrantColors[(colorIndex + i) % vibrantColors.length]
            );
            chartTooltipData = stat.fields.map((f) => f.tooltipData || []);
            chartTableData = stat.fields.map((f) => f.tableData || []);
          } else {
            chartLabels = ["Current", "Remaining"];
            chartData = [stat.current, stat.total - stat.current];
            chartColors = [vibrantColors[colorIndex], "#dee2e6"];
          }
          col.innerHTML = `
                  <div class="chart-card ${
                    index === homeSelectedStats[dept] ? "selected-stat" : ""
                  }">
                    <canvas id="dept-chart-${dept}-${index}" width="150" height="150"></canvas>
                    <div class="chart-center-label" id="dept-label-${dept}-${index}"></div>
                    <div class="chart-title">${stat.name}</div>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                      <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editStat('${dept}', ${index})"><i class="bi bi-pencil"></i> Edit</button>
                      <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); selectForHome('${dept}', ${index});"><i class="bi bi-house"></i> Show on Home</button>
                      <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteStat('${dept}', ${index})"><i class="bi bi-trash"></i> Delete</button>
                    </div>
                  </div>
                `;
          departmentStats.appendChild(col);
          // Chart click to select for home
          col.querySelector("canvas").onclick = () => {
            renderDepartmentStats(dept);
            showChartDetails(dept, index);
          };
          const ctx = document
            .getElementById(`dept-chart-${dept}-${index}`)
            .getContext("2d");
          if (stat.fields && stat.fields.length > 0 && index === 0) {
            const firstField = stat.fields[0];
            showTableForLabel(
              dept,
              stat.name,
              firstField.label,
              firstField.tableData || []
            );
          }

          const chartInstance = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: chartLabels,
              datasets: [
                {
                  data: chartData,
                  backgroundColor: chartColors,
                  tooltipData: chartTooltipData,
                  tableData: chartTableData,
                },
              ],
            },
            options: {
              cutout: "70%",
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const index = context.dataIndex;
                      const label = context.chart.data.labels[index];
                      const value = context.chart.data.datasets[0].data[index];
                      const tooltipDataArray =
                        context.chart.data.datasets[0].tooltipData || [];
                      const tooltipData = tooltipDataArray[index] || [];

                      const lines = [`${label}: ${value}`];
                      tooltipData.forEach((item) => {
                        lines.push(`${item.key}: ${item.value}`);
                      });
                      return lines;
                    },
                  },
                },
              },
            },
          });
          document.getElementById(`dept-chart-${dept}-${index}`).onclick =
            function (evt) {
              const points = chartInstance.getElementsAtEventForMode(
                evt,
                "nearest",
                { intersect: true },
                true
              );
              if (points.length) {
                const clickedIndex = points[0].index;
                const clickedLabel = chartInstance.data.labels[clickedIndex];
                const clickedTableData =
                  chartInstance.data.datasets[0].tableData[clickedIndex] || [];

                showTableForLabel(
                  dept,
                  stat.name,
                  clickedLabel,
                  clickedTableData
                );
                section.scrollIntoView({ behavior: "smooth", block: "start" });
              }
            };
          // Center label: total if fields, else current/total
          const total = stat.fields.reduce((sum, f) => sum + f.value, 0);
          document.getElementById(`dept-label-${dept}-${index}`).textContent =
            total;
        });

        // targetSection.innerHTML = `<h4 class="mt-4 mb-2">Department Targets</h4>`;
        // if (targets[dept].length === 0) {
        //   targetSection.innerHTML += `<p>No targets added.</p>`;
        // } else {
        //   let tableHTML = `
        //   <table class="target-table">
        //     <thead>
        //       <tr>
        //         <th>Title</th>
        //         <th>Target Date</th>
        //         <th>Status</th>
        //       </tr>
        //     </thead>
        //     <tbody>
        // `;

        //   targets[dept].forEach((t) => {
        //     const status = getTargetStatus(t.date);
        //     tableHTML += `
        //     <tr>
        //       <td>${t.title}</td>
        //       <td>${t.date}</td>
        //       <td><span class="${status.class}">${status.text}</span></td>
        //     </tr>
        //   `;
        //   });

        //   tableHTML += `
        //     </tbody>
        //   </table>
        // `;

        //   targetSection.innerHTML += tableHTML;
        // }

        renderDepartmentTable(dept);
        // document.getElementById("editTableBtn").onclick = () => editTable(dept);
      }

      function showTableForLabel(dept, statName, label, tableData) {
        const section = document.getElementById("chartDetailsSection");

        const stat = departmentData[dept].find((s) => s.name === statName);
        if (!stat || !stat.fields) return;

        let html = `
        <h5>${dept} - ${statName} Details - ${label}</h5>
        <div class="mb-3">
          <label class="form-label">Select Label:</label>
          <select class="form-select mb-3" id="labelDropdown">
      `;

        stat.fields.forEach((f) => {
          html += `<option ${f.label === label ? "selected" : ""}>${
            f.label
          }</option>`;
        });

        html += `</select>`;

        html += `
        <table class="target-table mb-3">
          <thead>
            <tr>
              <th>SN</th>
              <th>Issues</th>
              <th>Present status</th>
              <th>Concerned Dept</th>
              <th>Target date/ Requirement date</th>
            </tr>
          </thead>
          <tbody>
      `;

        tableData.forEach((item, i) => {
          html += `
          <tr>
            <td>${i + 1}</td>
            <td>${item.issues || ""}</td>
            <td>${item.status || ""}</td>
            <td>${item.dept || ""}</td>
            <td>${item.date || ""}</td>
          </tr>
        `;
        });

        html += `</tbody></table></div>`;

        section.innerHTML = html;

        document
          .getElementById("labelDropdown")
          .addEventListener("change", function () {
            const selectedLabel = this.value;
            const selectedField = stat.fields.find(
              (f) => f.label === selectedLabel
            );
            showTableForLabel(
              dept,
              statName,
              selectedLabel,
              selectedField.tableData || []
            );
          });

        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      function renderDepartmentTable(dept) {
        const tableData = departmentTables[dept];
        if (!tableData) return;

        let html = `<table class="target-table"><thead><tr>`;
        tableData.columns.forEach((col) => {
          html += `<th>${col}</th>`;
        });
        html += `</tr></thead><tbody>`;
        tableData.rows.forEach((row) => {
          html += `<tr>`;
          row.forEach((cell) => {
            html += `<td>${cell}</td>`;
          });
          html += `</tr>`;
        });
        html += `</tbody></table>`;

        // document.getElementById("tableContainer").innerHTML = html;
      }

      function editTable(dept) {
        const tableData = departmentTables[dept];
        const cols = prompt(
          "Enter column names separated by commas:",
          tableData.columns.join(",")
        );
        if (cols === null) return;
        tableData.columns = cols.split(",").map((c) => c.trim());

        const rows = prompt(
          "Enter rows as semi-colon separated lines. Each row comma separated values:\nExample:\nTask1,Done;Task2,Pending",
          tableData.rows.map((r) => r.join(",")).join(";")
        );
        if (rows === null) return;
        tableData.rows = rows
          .split(";")
          .map((r) => r.split(",").map((c) => c.trim()));

        renderDepartmentTable(dept);
      }

      function showChartDetails(dept, index) {
        const stat = departmentData[dept][index];
        const detailsSection = document.getElementById("chartDetailsSection");

        let html = `
                          <h4>Details for: ${stat.name}</h4>
                          <ul class="list-group mb-3">
                            <li class="list-group-item"><strong>Total:</strong> ${stat.fields.reduce(
                              (sum, f) => sum + f.value,
                              0
                            )}</li>
                          `;

        if (stat.fields && stat.fields.length > 0) {
          html += `<li class="list-group-item"><strong>Breakdown:</strong><ul>`;
          stat.fields.forEach((f) => {
            html += `<li>${f.label}: ${f.value}</li>`;
          });
          html += `</ul></li>`;
        }

        html += `</ul>`;

        detailsSection.innerHTML = html;
      }
      function getTargetStatus(targetDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const target = new Date(targetDate);
        target.setHours(0, 0, 0, 0);
        const diffTime = target - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
          return {
            text: `Overdue by ${Math.abs(diffDays)} days`,
            class: "overdue",
          };
        } else if (diffDays === 0) {
          return { text: "Due Today", class: "upcoming" };
        } else {
          return { text: "Upcoming", class: "upcoming" };
        }
      }

      function selectForHome(dept, index) {
        homeSelectedStats[dept] = index;
        updateHomeChart(dept);
      }
      function updateHomeChart(dept) {
        const chart = charts[dept];
        if (!departmentData[dept] || departmentData[dept].length === 0) return;

        let index = homeSelectedStats[dept];
        if (typeof index !== "number" || index >= departmentData[dept].length) {
          index = 0; // fallback to first available stat
          homeSelectedStats[dept] = 0;
        }

        const stat = departmentData[dept][index];
        if (!stat || !stat.fields) return;

        chart.data.labels = stat.fields.map((f) => f.label);
        chart.data.datasets[0].extras = stat.fields.map((f) => f.extra || []);
        chart.data.datasets[0].data = stat.fields.map((f) => f.value);
        chart.data.datasets[0].backgroundColor = stat.fields.map(
          (_, i) =>
            vibrantColors[
              (departments.indexOf(dept) + i) % vibrantColors.length
            ]
        );

        const total = stat.fields.reduce((sum, f) => sum + f.value, 0);
        document.getElementById(`label-${dept}`).textContent = total;
        document.getElementById(`title-${dept}`).textContent = stat.name;
        chart.update();
      }
      function editStat(dept, index) {
        const stat = departmentData[dept][index];
        editingStat = { dept, index };
        document.getElementById("departmentSelect").value = dept;
        document.getElementById("departmentSelect").disabled = true;
        document.getElementById("statName").value = stat.name;
        setFieldsInModal(stat.fields);
        document.querySelector("#statModal .modal-title").textContent =
          "Edit Statistic";
        document.getElementById("statSubmitBtn").textContent = "Save";
        const modal = new bootstrap.Modal(document.getElementById("statModal"));
        modal.show();
      }

      function deleteStat(dept, index) {
        if (!confirm("Are you sure you want to delete this statistic?")) return;
        departmentData[dept].splice(index, 1);
        // Adjust homeSelectedStats if needed
        if (homeSelectedStats[dept] === index) {
          homeSelectedStats[dept] = departmentData[dept].length > 0 ? 0 : null;
        } else if (homeSelectedStats[dept] > index) {
          homeSelectedStats[dept]--;
        }
        updateHomeChart(dept);
        renderDepartmentStats(dept);
      }

      function editDepartmentStat(dept, index) {
        const regular =
          parseInt(document.getElementById(`regular-${dept}-${index}`).value) ||
          0;
        const contractual =
          parseInt(
            document.getElementById(`contractual-${dept}-${index}`).value
          ) || 0;
        const yp =
          parseInt(document.getElementById(`yp-${dept}-${index}`).value) || 0;

        // Update the department data
        departmentData[dept][index].regular = regular;
        departmentData[dept][index].contractual = contractual;
        departmentData[dept][index].yp = yp;

        alert(
          `Updated statistics for ${dept}: Regular=${regular}, Contractual=${contractual}, YP=${yp}`
        );
      }
      function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      document.getElementById("collapseBtn").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("collapsed");
      });

      // Make addField globally accessible for modal
      window.addField = addField;
      window.editStat = editStat;
      window.deleteStat = deleteStat;
    </script>
  </body>
</html>
